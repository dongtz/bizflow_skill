# Run 工作流：一键生成流程文档与 BRD

生成/更新 `outputs/01_process.md` 和 `outputs/02_brd.md`，并执行 QA 门禁检查。

## 输入

可选主题提示（用户提供或从 `inputs/00_intake.md` 推断）。

---

## Step 1 — 前置检查

若 `inputs/00_intake.md` 不存在或明显缺失信息：
- 提示建议先执行 Capture
- 仍可继续生成"可讨论版"（在文档顶部标注：`⚠️ 基于不完整信息生成，仅供讨论`）

## Step 2 — 生成/更新 outputs/01_process.md

覆盖写入，固定结构。**§3 必须含 flowchart 图，§5 如适用必须含 stateDiagram-v2 图。**

所有 Mermaid 代码必须遵循 SKILL.md 中的 Mermaid 语法规则并通过自检清单。

```markdown
# 业务流程文档：<主题>

## 1. 业务目标与范围
- 目标：<一句话>
- In Scope：
- Out of Scope：
- 不确定项标【待确认】

## 2. 角色 / 系统 / 数据对象
| 名称 | 类型 | 职责/说明 |
|------|------|-----------|

## 3. 主流程

### 3.1 流程图

（使用 flowchart TD 或 LR）
（判断节点用菱形 {}，子流程用 subgraph，不确定步骤用虚线 -.-）
（涉及多角色时用 subgraph 按角色/泳道分组）

### 3.2 步骤明细

| 步骤 | 角色/系统 | 动作 | 输入 | 输出 | 决策点 | 备注 |
|------|-----------|------|------|------|--------|------|
不确定步骤标【待确认】并引用 [来源N]

### 3.3 角色交互时序（如涉及多系统/多角色交互）

（使用 sequenceDiagram，可选：仅当流程涉及 ≥3 个参与方的异步交互时生成）

## 4. 异常与边界处理
必须覆盖最低集合：
### 4.1 权限控制
### 4.2 超时 / 重试
### 4.3 重复提交 / 幂等
### 4.4 人工介入
### 4.5 对账 / 纠错 / 撤销 / 回退
不适用的注明理由

## 5. 状态机 / 生命周期

如适用（存在明确的状态流转，如订单状态、审批状态）：
使用 stateDiagram-v2 画出状态流转图
不适用则标"本场景无独立状态机"

## 6. 关键规则
- 校验规则
- 计算规则
- 路由规则
- 审批规则
- 幂等规则

## 7. Open Questions（≤10，可秒回）
| # | 问题 | 回复方式 | 优先级 | 风险 | 来源依据 | 建议确认人 |
|---|------|----------|--------|------|---------|-----------|
（来源依据列填 [来源N]，不填 EntryId 原始编号）

## 8. 引用与依据

| 编号 | 来源描述 | EntryId |
|------|---------|---------|
| [来源1] | <可读描述> | <仅供内部溯源> |
| [来源2] | ... | ... |

引用 research/sources.md 中的条目
缺失标【待补引用】并列检索主题 Top3
```

## Step 3 — 检索合规/规范引用

若发现合规/规范/口径触发点：
1. 列出待检索主题 Top3 与关键词
2. 能检索到则写入 `research/sources.md` 并在文档中回填引用
3. 不能检索则标 `【待补引用】`

## Step 4 — 生成/更新 outputs/02_brd.md

覆盖写入，固定结构：

```markdown
# BRD：<主题>

## 1. 背景与目标
### 1.1 项目背景
### 1.2 业务目标
### 1.3 成功指标

## 2. 现状与痛点
### 2.1 现状描述
### 2.2 痛点列表
| 痛点 | 影响范围 | 频率 | 来源依据 |
|------|----------|------|---------|

## 3. 目标流程

### 3.1 流程全景图

（使用 flowchart TD/LR，从业务视角重绘或引用 01_process.md 的流程图）
（比 01_process 更简化：聚焦核心路径，省略技术细节）

### 3.2 流程说明
补充业务视角说明

## 4. 业务规则与例外
| 规则 | 条件 | 处理方式 | 例外场景 |
|------|------|----------|----------|

## 5. 范围定义
### 5.1 In Scope
### 5.2 Out of Scope
### 5.3 后续迭代（Backlog）

## 6. 风险与合规
| 风险项 | 等级 | 缓解措施 | 来源依据 |
|--------|------|----------|---------|
缺失引用标【待补引用】

## 7. 未决事项与行动项
| # | 事项 | 负责人 | 截止时间 | 状态 |
|---|------|--------|----------|------|
```

## Step 5 — QA 门禁检查

检查清单：

| 检查项 | 要求 |
|--------|------|
| 异常覆盖 | 01_process 的 §4 覆盖全部 5 个最低异常类别 |
| 引用完整 | 无遗留 `【待补引用】`，或已列出检索主题 |
| 确认点格式 | Open Questions 均为可秒回格式 |
| 冲突标注 | 所有已知冲突均已标注双方 EntryId |
| BRD 完整 | 02_brd 覆盖全部 7 个章节 |
| **Mermaid 语法** | 所有 Mermaid 图通过自检清单（节点 ID 英文、标签加引号、闭合标签完整、前后空行） |
| **Mermaid 覆盖** | 01_process §3 有 flowchart 图；§5 如适用有 stateDiagram-v2 图；02_brd §3 有流程全景图 |

将检查结果追加到 `decisions.md`：

```markdown
## Run - <日期时间>

### QA 门禁结果
| 检查项 | 状态 | 备注 |
|--------|------|------|

### 最小补齐清单（3-8 条）
1. ...

### 下一次对齐议程（≤5 条）
1. ...
```

## 完成后提示（必须向用户输出）

```
---
✅ 流程文档 + BRD 已生成
   - outputs/01_process.md（业务流程文档）
   - outputs/02_brd.md（业务需求文档）
   - QA 门禁：N 项通过 / M 项待补齐

👉 下一步：查看 & 补齐
   1. 查看两份文档，有修改意见随时说
   2. 如有待补齐项，按清单补充材料后说"追加材料"再"生成 BRD"刷新

💡 你也可以：
   - 追加新材料后重新生成（整个流程可反复迭代）
   - 说"导出"获取最终版本
   - 针对某个章节说"展开 §4 异常处理"获得更详细内容
---
```
